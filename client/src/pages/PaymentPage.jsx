import React, { useState, useRef, useEffect, useContext } from "react";
import InputField from "../component/InputField.jsx";
import usePayment from "../hooks/usePayment.js";
import AddressModal from "../component/AddressModal.jsx";
import CartItem from "../component/cart/CartItem.jsx";
import Summary from "../component/cart/Summary.jsx";
import { useCart } from "../hooks/useCart.js";
import { AuthContext } from "../context/AuthContext.js";
import { CartContext } from "../context/CartContext.js";
import { useLocation, useNavigate } from "react-router-dom";
import axios from "axios";

export default function PaymentPage() {
    const { isLoggedIn } = useContext(AuthContext);
    const { cartList, totalPrice, setCartCount, setCartList } = useContext(CartContext);
    const { getCartList, updateCartList, deleteCartItem } = useCart();
    const location = useLocation();
    const navigate = useNavigate();
    const searchParams = new URLSearchParams(location.search);
    const pgToken = searchParams.get("pg_token");
    const [userData, setUserData] = useState({ name: "", email: "", phone: "" });

    // Î°úÍ∑∏Ïù∏ ÏÉÅÌÉúÏù¥Î©¥ ÏÇ¨Ïö©Ïûê Ï†ïÎ≥¥ API Ìò∏Ï∂ú
    useEffect(() => {
        if (isLoggedIn) {
            getCartList();
            const token = localStorage.getItem("token");
            fetch("http://localhost:9000/member/userinfo", {
                method: "GET",
                headers: {
                    "Content-Type": "application/json",
                    Authorization: `Bearer ${token}`,
                },
            })
                .then((res) => res.json())
                .then((data) => setUserData(data))
                .catch((err) =>
                    console.error("ÏÇ¨Ïö©Ïûê Ï†ïÎ≥¥Î•º Í∞ÄÏ†∏Ïò§ÎäîÎç∞ Ïã§Ìå®ÌñàÏäµÎãàÎã§.", err)
                );
        } else {
            setUserData({ name: "", email: "", phone: "" });
        }
    }, [isLoggedIn]);

    const [paymentMethod, setPaymentMethod] = useState("creditCard");
    const [shippingAddress, setShippingAddress] = useState(null);
    const [address, setAddress] = useState("");
    const [zipcode, setZipcode] = useState("");
    const [detailAddress, setDetailAddress] = useState("");
    const [isModalOpen, setIsModalOpen] = useState(false);

    // ÏóêÎü¨ ÏÉÅÌÉú (Ïö∞Ìé∏Î≤àÌò∏, ÏÉÅÏÑ∏Ï£ºÏÜå)
    const [zipcodeError, setZipcodeError] = useState(null);
    const [detailAddressError, setDetailAddressError] = useState(null);

    // Í∞Å ÌïÑÎìúÏùò ref
    const zipcodeRef = useRef(null);
    const addressRef = useRef(null);
    const detailAddressRef = useRef(null);

    const {
        cardNumber,
        setCardNumber,
        expiryDate,
        setExpiryDate,
        cvcNumber,
        setCvcNumber,
        cardError,
        expiryDateError,
        cvcError,
        shake,
        validateCardNumber,
        validateExpiryDate,
        validateCvcNumber,
    } = usePayment();

    const handlePaymentMethodChange = (method) => {
        setPaymentMethod(method);
    };

    const handleAddressSelect = (addressData) => {
        setShippingAddress(addressData);
    };

    const handleOpenModal = () => {
        setIsModalOpen(true);
    };
    const handleCloseModal = () => {
        setIsModalOpen(false);
    };

    const onAddressSelected = (addressData) => {
        setAddress(addressData.address);
        setZipcode(addressData.zipcode);
        handleAddressSelect(addressData);
        handleCloseModal();
        setZipcodeError(null);
    };

    const handleDetailAddressChange = (e) => {
        setDetailAddress(e.target.value);
        if (e.target.value) {
            setDetailAddressError(null);
        }
    };

    // ÌÅ¨Î†àÎîß Ïπ¥Îìú Í≤∞Ï†ú: Ï¶âÏãú Ï£ºÎ¨∏ ÏÉùÏÑ± API Ìò∏Ï∂ú
    const handleCreditCardPayment = async (orderData) => {
        validateCardNumber();
        const cleanedCard = cardNumber.replace(/-/g, "");
        if (!cardNumber || cleanedCard.length < 16) return;
        validateExpiryDate();
        if (!expiryDate || expiryDate.length !== 5) return;
        validateCvcNumber();
        if (!cvcNumber || cvcNumber.length !== 3) return;

        try {
            const response = await axios.post(
                "http://localhost:9000/order/checkout",
                orderData
            );
            console.log("‚úÖ [DEBUG] Ï£ºÎ¨∏ ÏùëÎãµ:", response.data);
            if (response.status === 201) {
                setCartList([]); // Ïû•Î∞îÍµ¨Îãà ÎπÑÏö∞Í∏∞
                setCartCount(0);
                localStorage.setItem("orderData", JSON.stringify(orderData));
                navigate("/order-success");
            }
        } catch (error) {
            console.error(
                "‚ùå Ï£ºÎ¨∏ ÏöîÏ≤≠ Ï§ë Ïò§Î•ò Î∞úÏÉù:",
                error.response?.data || error.message
            );
            alert("Ï£ºÎ¨∏ Ï≤òÎ¶¨ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.");
        }
    };

    // Ïπ¥Ïπ¥Ïò§ÌéòÏù¥ Í≤∞Ï†ú: QR Í≤∞Ï†ú API Ìò∏Ï∂ú ÌõÑ Î¶¨Îã§Ïù¥Î†âÌä∏ (Ï£ºÎ¨∏ Îç∞Ïù¥ÌÑ∞Îäî localStorageÏóê Ï†ÄÏû•)
    const handleKakaoPayPayment = async (orderData) => {
        const id = localStorage.getItem("user_id");
        try {
            const res = await axios.post("http://localhost:9000/payment/qr", {
                id: id,
                item_name: "ÌÖåÏä§Ìä∏ ÏÉÅÌíà",
                total_amount: totalPrice,
            });
            console.log("‚úÖ [DEBUG] Ïπ¥Ïπ¥Ïò§ÌéòÏù¥ ÏùëÎãµ:", res.data);
            if (res.data.next_redirect_pc_url) {
                // ÏäπÏù∏ URLÎ°ú Î¶¨Îã§Ïù¥Î†âÌä∏ÌïòÍ∏∞ Ï†ÑÏóê ÌïÑÏöîÌïú Í∞íÎì§ÏùÑ localStorageÏóê Ï†ÄÏû•Ìï©ÎãàÎã§.
                localStorage.setItem("orderData", JSON.stringify(orderData));
                localStorage.setItem("tid", res.data.tid);
                localStorage.setItem("total_price", totalPrice);
                localStorage.setItem("partner_order_id", res.data.partner_order_id);
                window.location.href = res.data.next_redirect_pc_url;
            }
        } catch (error) {
            console.log("‚ùå Ïπ¥Ïπ¥Ïò§ÌéòÏù¥ QR Í≤∞Ï†ú ÏóêÎü¨ Î∞úÏÉù", error);
        }
    };

    // Í≤∞Ï†ú ÏäπÏù∏ ÌõÑ DBÏóê Ï£ºÎ¨∏ ÏÉùÏÑ± (Í≥µÌÜµ Ìï®Ïàò)
    const confirmPayment = async (orderData, tid) => {
        try {
            const finalOrderData = { ...orderData, tid };
            const orderResponse = await axios.post(
                "http://localhost:9000/order/checkout",
                finalOrderData
            );
            console.log("‚úÖ [DEBUG] ÏµúÏ¢Ö Ï£ºÎ¨∏ ÏùëÎãµ:", orderResponse.data);
            if (orderResponse.status === 201) {
                setCartList([]); // Ïû•Î∞îÍµ¨Îãà ÎπÑÏö∞Í∏∞
                localStorage.setItem("orderData", JSON.stringify(finalOrderData));
                navigate("/order-success");
            }
        } catch (error) {
            console.error(
                "‚ùå Ï£ºÎ¨∏ Ï†ÄÏû• Ïò§Î•ò Î∞úÏÉù:",
                error.response?.data || error.message
            );
            alert("Ï£ºÎ¨∏ Ï≤òÎ¶¨ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.");
        }
    };

    // Ïπ¥Ïπ¥Ïò§ÌéòÏù¥ ÏäπÏù∏ Ï≤òÎ¶¨ (QR Ïù∏Ï¶ù ÌõÑ)
    const handleKakaoPayApprove = async (pgToken) => {
        const id = localStorage.getItem("user_id");
        const tid = localStorage.getItem("tid");
        const totalPrice = localStorage.getItem("total_price");
        try {
            const res = await axios.post("http://localhost:9000/payment/approve", {
                pg_token: pgToken,
                tid,
                id,
                total_amount: totalPrice,
            });
            console.log("‚úÖ [DEBUG] Ïπ¥Ïπ¥Ïò§ÌéòÏù¥ ÏäπÏù∏ ÏÑ±Í≥µ:", res.data);
            localStorage.removeItem("tid");
            localStorage.removeItem("total_price");
            // localStorageÏóê Ï†ÄÏû•ÌñàÎçò Ï£ºÎ¨∏ Îç∞Ïù¥ÌÑ∞Î•º Í∞ÄÏ†∏ÏôÄ DBÏóê Ï£ºÎ¨∏ ÏÉùÏÑ±
            const storedOrderData = JSON.parse(localStorage.getItem("orderData"));
            await confirmPayment(storedOrderData, tid);
        } catch (error) {
            console.error("‚ùå Ïπ¥Ïπ¥Ïò§ÌéòÏù¥ ÏäπÏù∏ Ïã§Ìå®:", error);
            alert("Í≤∞Ï†ú ÏäπÏù∏ Ï§ë Ïò§Î•ò Î∞úÏÉù");
        }
    };

    // pg_tokenÏù¥ ÏûàÏùÑ Í≤ΩÏö∞ Ïπ¥Ïπ¥Ïò§ÌéòÏù¥ ÏäπÏù∏ Ï≤òÎ¶¨ Ïã§Ìñâ (QR Ïù∏Ï¶ù ÌõÑ Î¶¨Îã§Ïù¥Î†âÌä∏ Ïãú)
    useEffect(() => {
        if (pgToken) {
            handleKakaoPayApprove(pgToken);
        }
    }, [pgToken]);

    // Í≤∞Ï†úÌïòÍ∏∞ Î≤ÑÌäº ÌÅ¥Î¶≠ Ïãú Ïã§Ìñâ
    const handleSubmit = async () => {
        if (!cartList || cartList.length === 0) {
            alert("Ïπ¥Ìä∏Ïóê Îã¥Í∏¥ ÏÉÅÌíàÏù¥ ÏóÜÏäµÎãàÎã§. Î®ºÏ†Ä ÏÉÅÌíàÏùÑ Îã¥ÏïÑÏ£ºÏÑ∏Ïöî.");
            navigate("/");
            return;
        }
        if (!zipcode) {
            setZipcodeError("Ï£ºÏÜå Í≤ÄÏÉâÏùÑ ÌÜµÌï¥ Î∞∞ÏÜ°ÏßÄÎ•º ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.");
            zipcodeRef.current?.focus();
            return;
        }
        if (!detailAddress) {
            setDetailAddressError("ÏÉÅÏÑ∏Ï£ºÏÜåÎ•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.");
            detailAddressRef.current?.focus();
            return;
        }

        const cartItems = cartList.map((item) => ({
            product_id: item.pid,
            product_name: item.pname,
            kinds: item.kinds,
            qty: item.qty,
            unit_price: item.price,
            color: item.color,
            case_type: item.cname,
            product_image: item.image,
        }));
        console.log('Ïπ¥Ìä∏Î¶¨Ïä§Ìä∏',cartList);
        

        const orderData = {
            member_id: localStorage.getItem("user_id"),
            total_price: totalPrice,
            payment_method: paymentMethod,
            zipcode,
            address,
            detail_address: detailAddress,
            cartItems,
        };

        console.log("üîç [DEBUG] Ï£ºÎ¨∏ Îç∞Ïù¥ÌÑ∞:", orderData);

        if (paymentMethod === "creditCard") {
            await handleCreditCardPayment(orderData);
        } else if (paymentMethod === "kakaoPay") {
            await handleKakaoPayPayment(orderData);
        }
    };

    


    return (
        <div className="flex justify-center w-full min-h-screen mt-66">
            <div className="flex w-full max-w-[1000px] min-h-screen font-sans">
                <div className="w-[60%] p-8">
                    <div className="mb-8">
                        <h2 className="mb-20 font-bold text-32">Íµ¨Îß§Ïûê Ï†ïÎ≥¥</h2>
                        <InputField
                            id="buyerName"
                            type="text"
                            label="Ïù¥Î¶Ñ"
                            value={userData.name}
                            readOnly
                        />
                        <InputField
                            id="buyerEmail"
                            type="text"
                            label="Ïù¥Î©îÏùº"
                            value={userData.email}
                            readOnly
                        />
                        <InputField
                            id="buyerPhone"
                            type="text"
                            label="Ï†ÑÌôîÎ≤àÌò∏"
                            value={userData.phone}
                            readOnly
                        />
                    </div>

                    <div className="mb-8">
                        <h2 className="mb-20 font-bold text-32">Î∞∞ÏÜ°ÏßÄ Ï†ïÎ≥¥</h2>
                        <div className="flex items-center justify-between mb-2">
                            <p className="text-14">Î∞∞ÏÜ° Î∞õÏúºÏã§ Ï£ºÏÜåÎ•º ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.</p>
                            <button
                                onClick={handleOpenModal}
                                className="px-6 py-10 mb-10 ml-5 text-white rounded-6 w-80 text-12 bg-blue"
                            >
                                Ï£ºÏÜå Í≤ÄÏÉâ
                            </button>
                        </div>
                        <div>
                            <InputField
                                id="zipcode"
                                type="text"
                                label="Ïö∞Ìé∏Î≤àÌò∏"
                                value={zipcode}
                                readOnly
                                refElement={zipcodeRef}
                                error={zipcodeError}
                            />
                            <InputField
                                id="address"
                                type="text"
                                label="Ï£ºÏÜå"
                                value={address}
                                readOnly
                                refElement={addressRef}
                            />
                            <InputField
                                id="detailAddress"
                                type="text"
                                label="ÏÉÅÏÑ∏Ï£ºÏÜå (Îèô/Ìò∏Ïàò, Ï∏µÏàò)"
                                value={detailAddress}
                                setValue={setDetailAddress}
                                refElement={detailAddressRef}
                                error={detailAddressError}
                                onChange={handleDetailAddressChange}
                            />
                            <AddressModal
                                isOpen={isModalOpen}
                                onClose={handleCloseModal}
                                onAddressSelected={onAddressSelected}
                            />
                        </div>
                    </div>

                    <div>
                        <h2 className="mb-20 font-bold text-32">Í≤∞Ï†ú ÏàòÎã®</h2>
                        <div className="mb-20">
                            <div
                                className={`mb-15 px-15 py-10 border rounded-12 cursor-pointer ${paymentMethod === "creditCard"
                                        ? "border-blue-500 bg-blue-100"
                                        : "border-gray-300"
                                    }`}
                                onClick={() => handlePaymentMethodChange("creditCard")}
                            >
                                <label className="flex items-center gap-5 cursor-pointer">
                                    <span
                                        className={`w-15 h-15 rounded-full mb-2 border ${paymentMethod === "creditCard" ? "bg-black" : "bg-white"
                                            }`}
                                    ></span>
                                    <span className="text-base font-medium">Credit Card</span>
                                </label>
                                {paymentMethod === "creditCard" && (
                                    <div className="mt-5">
                                        <InputField
                                            id="cardNumber"
                                            type="text"
                                            label="Ïπ¥Îìú Î≤àÌò∏"
                                            value={cardNumber}
                                            setValue={setCardNumber}
                                            maxLength={19}
                                            inputType="number-only"
                                            validate={validateCardNumber}
                                            error={cardError}
                                            shake={shake.cardNumber}
                                        />
                                        <InputField
                                            id="expiryDate"
                                            type="text"
                                            label="Ïú†Ìö®Í∏∞Í∞Ñ(MM/YY)"
                                            value={expiryDate}
                                            setValue={setExpiryDate}
                                            maxLength={5}
                                            placeholder="MM/YY"
                                            validate={validateExpiryDate}
                                            error={expiryDateError}
                                            shake={shake.expiryDate}
                                        />
                                        <InputField
                                            id="cvcNumber"
                                            type="text"
                                            label="CVC"
                                            value={cvcNumber}
                                            setValue={setCvcNumber}
                                            maxLength={3}
                                            inputType="number-only"
                                            validate={validateCvcNumber}
                                            error={cvcError}
                                            shake={shake.cvcNumber}
                                        />
                                    </div>
                                )}
                            </div>
                            <div
                                className={`px-15 py-10 border rounded-12 cursor-pointer ${paymentMethod === "kakaoPay"
                                        ? "border-blue-500 bg-blue-100"
                                        : "border-gray-300"
                                    }`}
                                onClick={() => handlePaymentMethodChange("kakaoPay")}
                            >
                                <label className="flex items-center gap-5 cursor-pointer">
                                    <span
                                        className={`w-15 h-15 rounded-full mb-2 border ${paymentMethod === "kakaoPay" ? "bg-black" : "bg-white"
                                            }`}
                                    ></span>
                                    <span className="text-base font-medium text-gray-700">
                                        Ïπ¥Ïπ¥Ïò§ÌéòÏù¥
                                    </span>
                                </label>
                            </div>
                        </div>
                        <div className="my-10">
                            <button
                                className="w-full p-12 text-white rounded-12 bg-blue"
                                onClick={handleSubmit}
                            >
                                Í≤∞Ï†úÌïòÍ∏∞
                            </button>
                        </div>
                    </div>
                </div>

                <div className="w-[35%] ml-[5%] p-8">
                    <h2 className="mb-20 font-bold text-32">Ï£ºÎ¨∏ ÏÉÅÌíà Ï†ïÎ≥¥</h2>
                    <CartItem
                        cartList={cartList}
                        updateCartList={updateCartList}
                        deleteCartItem={deleteCartItem}
                    />
                    <Summary 
                        totalPrice={totalPrice}
                    />
                </div>
            </div>
        </div>
    );
}
